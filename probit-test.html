<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Probit Devigging Test</title>
</head>
<body>
    <h1>Probit Devigging Test</h1>
    <div id="results"></div>
    <script>
        // Inverse normal CDF approximation (probit function)
        function probit(p) {
            // Approximation using Beasley-Springer-Moro algorithm
            const a0 = 2.50662823884;
            const a1 = -18.61500062529;
            const a2 = 41.39119773534;
            const a3 = -25.44106049637;
            const b0 = -8.47351093090;
            const b1 = 23.08336743743;
            const b2 = -21.06224101826;
            const b3 = 3.13082909833;
            const c0 = 0.3374754822726147;
            const c1 = 0.9761690190917186;
            const c2 = 0.1607979714918209;
            const c3 = 0.0276438810333863;
            const c4 = 0.0038405729373609;
            const c5 = 0.0003951896511919;
            const c6 = 0.0000321767881768;
            const c7 = 0.0000002888167364;
            const c8 = 0.0000003960315187;

            if (p <= 0 || p >= 1) return null;
            if (p === 0.5) return 0;

            let x = p - 0.5;
            let r;

            if (Math.abs(x) < 0.42) {
                r = x * x;
                r = x * (((a3 * r + a2) * r + a1) * r + a0) / ((((b3 * r + b2) * r + b1) * r + b0) * r + 1.0);
            } else {
                r = p;
                if (x > 0) r = 1 - p;
                r = Math.log(-Math.log(r));
                r = c0 + r * (c1 + r * (c2 + r * (c3 + r * (c4 + r * (c5 + r * (c6 + r * (c7 + r * c8)))))));
                if (x < 0) r = -r;
            }
            return r;
        }

        // Normal CDF approximation (to convert z-score back to probability)
        function normCDF(z) {
            // Approximation using Abramowitz and Stegun
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;

            const sign = z < 0 ? -1 : 1;
            z = Math.abs(z) / Math.sqrt(2.0);

            const t = 1.0 / (1.0 + p * z);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);

            return 0.5 * (1.0 + sign * y);
        }

        // Convert American odds to implied probability
        function americanToImpliedProb(odds) {
            if (odds > 0) {
                return 100 / (odds + 100);
            } else {
                return -odds / (-odds + 100);
            }
        }

        // Convert probability to American odds
        function probToAmerican(prob) {
            if (prob >= 0.5) {
                return -(prob * 100) / (1 - prob);
            } else {
                return (100 * (1 - prob)) / prob;
            }
        }

        // Probit devigging method
        function probitDevig(favOdds, dogOdds) {
            // Get implied probabilities
            const favImplied = americanToImpliedProb(favOdds);
            const dogImplied = americanToImpliedProb(dogOdds);
            
            // Convert to z-scores using probit
            const zFav = probit(favImplied);
            const zDog = probit(dogImplied);
            
            // Average the z-scores (true market is midpoint)
            const zTrue = (zFav + zDog) / 2;
            
            // Convert back to probabilities
            const trueFavProb = normCDF(zTrue);
            const trueDogProb = 1 - trueFavProb;
            
            return {
                favImplied: favImplied,
                dogImplied: dogImplied,
                zFav: zFav,
                zDog: zDog,
                zTrue: zTrue,
                trueFavProb: trueFavProb,
                trueDogProb: trueDogProb,
                trueFavLine: probToAmerican(trueFavProb),
                trueDogLine: probToAmerican(trueDogProb)
            };
        }

        // Test cases
        const testCases = [
            { fav: -130, dog: 110 },
            { fav: -160, dog: 125 },
            { fav: -800, dog: 550 }
        ];

        let results = [];
        results.push('<h2>Probit Devigging Results</h2>');
        results.push('<table border="1" cellpadding="5" style="border-collapse: collapse;">');
        results.push('<tr><th>Input</th><th>Implied Fav</th><th>Implied Dog</th><th>True Fav Prob</th><th>True Fav Line</th><th>True Dog Line</th></tr>');

        testCases.forEach(test => {
            const result = probitDevig(test.fav, test.dog);
            results.push(`
                <tr>
                    <td>${test.fav} / +${test.dog}</td>
                    <td>${(result.favImplied * 100).toFixed(2)}%</td>
                    <td>${(result.dogImplied * 100).toFixed(2)}%</td>
                    <td>${(result.trueFavProb * 100).toFixed(2)}%</td>
                    <td>${result.trueFavLine.toFixed(1)}</td>
                    <td>+${result.trueDogLine.toFixed(1)}</td>
                </tr>
            `);
        });

        results.push('</table>');
        
        // Detailed output for first test case
        const detail1 = probitDevig(-130, 110);
        results.push('<h3>Detailed Example: -130 / +110</h3>');
        results.push(`<ul>
            <li>Implied Favorite: ${(detail1.favImplied * 100).toFixed(2)}%</li>
            <li>Implied Underdog: ${(detail1.dogImplied * 100).toFixed(2)}%</li>
            <li>Z-score Favorite: ${detail1.zFav.toFixed(4)}</li>
            <li>Z-score Underdog: ${detail1.zDog.toFixed(4)}</li>
            <li>True Z-score (average): ${detail1.zTrue.toFixed(4)}</li>
            <li><strong>True Favorite Probability: ${(detail1.trueFavProb * 100).toFixed(2)}%</strong></li>
            <li><strong>True Favorite Line: ${detail1.trueFavLine.toFixed(1)}</strong></li>
            <li><strong>True Underdog Line: +${detail1.trueDogLine.toFixed(1)}</strong></li>
        </ul>`);

        document.getElementById('results').innerHTML = results.join('');
        console.log('Probit Devigging Test Results:', testCases.map(t => probitDevig(t.fav, t.dog)));
    </script>
</body>
</html>
